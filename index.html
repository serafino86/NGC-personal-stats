<!DOCTYPE html>

<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NGC Personal Stats - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d4a2b 50%, #1a1a1a 100%);
      background-attachment: fixed;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(30, 40, 30, 0.95);
      border: 3px solid #4a6b47;
      box-shadow: 0 0 30px rgba(74, 107, 71, 0.5);
    }

    .header {
      background: linear-gradient(135deg, #2d4a2b 0%, #1a2e1a 100%);
      color: #a8d5a3;
      padding: 30px;
      text-align: center;
      border-bottom: 3px solid #4a6b47;
      position: relative;
    }

    .language-selector {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      gap: 5px;
      z-index: 10;
    }

    .lang-btn {
      background: rgba(74, 107, 71, 0.3);
      border: 2px solid #4a6b47;
      color: #a8d5a3;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .lang-btn:hover {
      background: rgba(74, 107, 71, 0.5);
      border-color: #90EE90;
      color: #90EE90;
      transform: scale(1.05);
    }

    .lang-btn.active {
      background: #4a6b47;
      border-color: #90EE90;
      color: #90EE90;
      box-shadow: 0 0 10px rgba(144, 238, 144, 0.3);
    }

    .ngc-logo {
      font-size: 2.5em;
      font-weight: bold;
      color: #7fa87a;
      text-shadow: 0 0 10px rgba(127, 168, 122, 0.8);
      margin-bottom: 5px;
      letter-spacing: 8px;
    }

    .header h1 {
      font-size: 1.5em;
      color: #c4e3bf;
      letter-spacing: 3px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 0.95em;
      color: #a8d5a3;
    }

    .content { padding: 30px; }

    /* COMMON SECTION STYLES */
    .auth-section {
      background: linear-gradient(135deg, #2d4a2b 0%, #3d5a3b 100%);
      border: 2px solid #4a6b47;
      padding: 40px;
      margin-bottom: 30px;
      color: #c4e3bf;
    }

    .section-title {
      text-align: center;
      font-size: 1.3em;
      color: #7fa87a;
      margin-bottom: 30px;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .input-group {
      margin-bottom: 25px;
    }

    .input-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 1.1em;
      color: #a8d5a3;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #4a6b47;
      background: rgba(0, 0, 0, 0.4);
      color: #c4e3bf;
      font-size: 1.1em;
      font-family: 'Courier New', monospace;
    }

    .input-group input:focus {
      outline: none;
      border-color: #7fa87a;
      box-shadow: 0 0 10px rgba(127, 168, 122, 0.3);
    }

    .btn {
      padding: 15px 30px;
      border: 2px solid #4a6b47;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      font-family: 'Courier New', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
      background: linear-gradient(135deg, #4a6b47 0%, #5a7b57 100%);
      color: #c4e3bf;
      transition: all 0.3s;
      margin: 10px 0;
    }

    .btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #5a7b57 0%, #6a8b67 100%);
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #3d5a3b 0%, #4d6a4b 100%);
    }

    .alert {
      padding: 15px;
      margin: 15px 0;
      display: none;
      border: 2px solid;
      font-weight: bold;
    }

    .alert-error {
      background: rgba(107, 71, 71, 0.3);
      color: #d5a3a3;
      border-color: #a87a7a;
    }

    .alert-success {
      background: rgba(74, 107, 71, 0.3);
      color: #a8d5a3;
      border-color: #7fa87a;
    }

    .alert-info {
      background: rgba(74, 107, 107, 0.3);
      color: #a3d5d5;
      border-color: #7aa8a8;
    }

    .pin-display {
      background: rgba(127, 168, 122, 0.2);
      border: 3px solid #7fa87a;
      padding: 30px;
      margin: 20px 0;
      text-align: center;
    }

    .pin-code {
      font-size: 3em;
      color: #90EE90;
      font-weight: bold;
      letter-spacing: 8px;
      margin: 20px 0;
      text-shadow: 0 0 10px rgba(144, 238, 144, 0.5);
    }

    .pin-warning {
      background: rgba(255, 193, 7, 0.2);
      border: 2px solid #ffc107;
      padding: 15px;
      margin: 15px 0;
      color: #ffe082;
    }

    .link-text {
      color: #7fa87a;
      cursor: pointer;
      text-decoration: underline;
    }

    .link-text:hover {
      color: #90EE90;
    }

    /* DASHBOARD STYLES */
    .dashboard { 
      display: none;
      max-height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .welcome {
      background: linear-gradient(135deg, #4a6b47 0%, #5a7b57 100%);
      padding: 20px;
      margin-bottom: 30px;
      text-align: center;
      border: 2px solid #7fa87a;
    }

    .welcome h2 {
      color: #c4e3bf;
      font-size: 1.8em;
      letter-spacing: 2px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(45, 74, 43, 0.5);
      border: 2px solid #4a6b47;
      padding: 20px;
      text-align: center;
    }

    .stat-title {
      font-size: 0.9em;
      color: #a8d5a3;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 2em;
      color: #7fa87a;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-change {
      font-size: 1.1em;
      font-weight: bold;
    }

    .stat-change.positive { color: #90EE90; }
    .stat-change.negative { color: #ff6b6b; }
    .stat-change.neutral { color: #a8d5a3; }

    .chart-section {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #4a6b47;
      padding: 12px;
      margin-bottom: 15px;
    }

    .chart-title {
      font-size: 1.1em;
      color: #7fa87a;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      text-align: center;
    }

    .ranking-card {
      background: linear-gradient(135deg, #2d4a2b 0%, #1a2e1a 100%);
      border: 2px solid #4a6b47;
      padding: 25px;
      margin-bottom: 30px;
    }

    .ranking-position {
      text-align: center;
      font-size: 3em;
      color: #7fa87a;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .ranking-info {
      color: #c4e3bf;
      font-size: 1.1em;
      line-height: 1.8;
    }

    .history-table {
      width: 100%;
      min-width: 600px;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .history-table th:nth-child(1),
    .history-table td:nth-child(1) { 
      min-width: 70px;
      width: 70px;
    }

    .history-table th {
      background: #2d4a2b;
      color: #a8d5a3;
      padding: 12px;
      text-align: center;
      border: 1px solid #4a6b47;
      font-size: 0.9em;
    }

    .history-table td {
      background: rgba(0, 0, 0, 0.3);
      color: #c4e3bf;
      padding: 10px;
      text-align: center;
      border: 1px solid #4a6b47;
    }

    .history-table tr:nth-child(even) td {
      background: rgba(45, 74, 43, 0.2);
    }

    .logout-btn {
      margin-top: 30px;
      background: linear-gradient(135deg, #6b4747 0%, #7b5757 100%);
    }

    @media (max-width: 768px) {
      .ngc-logo { font-size: 2em; }
      .header h1 { font-size: 1.2em; }
      .content { padding: 15px; }
      .auth-section { padding: 20px; }
      .stats-grid { grid-template-columns: 1fr; }
      .pin-code { font-size: 2em; letter-spacing: 4px; }
    }
  </style>

</head>

<body>
  <div class="container">
    <div class="header">
      <div class="language-selector">
        <button class="lang-btn active" data-lang="it">üáÆüáπ IT</button>
        <button class="lang-btn" data-lang="en">üá¨üáß EN</button>
        <button class="lang-btn" data-lang="fr">üá´üá∑ FR</button>
      </div>
      <div class="ngc-logo">NGC</div>
      <h1>PERSONAL STATS DASHBOARD</h1>
      <p>üìä Track Your Growth & Progress</p>
    </div>

```
<div class="content">
  <!-- SCELTA INIZIALE -->
  <div id="choiceSection" class="auth-section">
    <div class="section-title">üîê Accesso</div>
    
    <p style="text-align: center; margin-bottom: 30px; font-size: 1.1em;">
      Prima volta o hai gi√† un PIN?
    </p>

    <button class="btn" id="firstTimeBtn">üÜï Prima Volta - Genera PIN</button>
    <button class="btn btn-secondary" id="havePINBtn">üîë Ho gi√† un PIN - Accedi</button>
  </div>

  <!-- REGISTRAZIONE (prima volta) -->
  <div id="registerSection" class="auth-section" style="display: none;">
    <div class="section-title">üÜï Genera il Tuo PIN</div>
    
    <div class="alert alert-info" style="display: block;">
      ‚ÑπÔ∏è Inserisci il tuo nome e il codice segreto dell'alleanza per generare il tuo PIN personale.
    </div>

    <div class="input-group">
      <label for="regPlayerName">üë§ Nome Giocatore:</label>
      <input type="text" id="regPlayerName" placeholder="Il tuo nome in-game" />
    </div>

    <div class="input-group">
      <label for="regSecretCode">üîë Codice Segreto Alleanza:</label>
      <input type="password" id="regSecretCode" placeholder="Codice NGC" />
    </div>

    <button class="btn" id="generatePINBtn">üé≤ Genera il Mio PIN</button>
    <button class="btn btn-secondary" id="backToChoiceBtn">‚¨ÖÔ∏è Indietro</button>
    
    <div class="alert alert-error" id="regErrorAlert"></div>
  </div>

  <!-- MOSTRA PIN GENERATO -->
  <div id="pinDisplaySection" class="auth-section" style="display: none;">
    <div class="section-title">üéâ PIN Generato con Successo!</div>
    
    <div class="pin-display">
      <p style="font-size: 1.2em; margin-bottom: 15px;">Il tuo PIN personale √®:</p>
      <div class="pin-code" id="generatedPIN">------</div>
      <p style="font-size: 0.95em; color: #a8d5a3;">Giocatore: <strong id="generatedPlayerName"></strong></p>
    </div>

    <div class="pin-warning">
      ‚ö†Ô∏è <strong>IMPORTANTE:</strong><br>
      ‚Ä¢ Salva questo PIN in un posto sicuro!<br>
      ‚Ä¢ Lo userai per accedere alle tue statistiche<br>
      ‚Ä¢ Se lo perdi, contatta il proprietario del database
    </div>

    <button class="btn" id="gotoPINLoginBtn">‚úÖ Ho Salvato il PIN - Continua</button>
  </div>

  <!-- LOGIN CON PIN -->
  <div id="loginSection" class="auth-section" style="display: none;">
    <div class="section-title">üîë Accedi con PIN</div>
    
    <div class="input-group">
      <label for="loginPlayerName">üë§ Nome Giocatore:</label>
      <input type="text" id="loginPlayerName" placeholder="Il tuo nome in-game" />
    </div>

    <div class="input-group">
      <label for="loginPIN">üîê PIN Personale:</label>
      <input type="text" id="loginPIN" placeholder="Il tuo PIN (6 caratteri)" maxlength="6" style="text-transform: uppercase;" />
    </div>

    <button class="btn" id="loginBtn">üìä Visualizza Statistiche</button>
    <button class="btn btn-secondary" id="backToChoice2Btn">‚¨ÖÔ∏è Indietro</button>
    
    <div class="alert alert-error" id="loginErrorAlert"></div>
    
    <p style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #a8d5a3;">
      PIN perso? Contatta il proprietario del database
    </p>
  </div>

  <!-- DASHBOARD SECTION -->
  <div id="dashboardSection" class="dashboard">
    <div class="welcome">
      <h2>üëã Benvenuto, <span id="welcomeName"></span>!</h2>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-title">üöÄ Missili</div>
        <div class="stat-value" id="statMissile">-</div>
        <div class="stat-change" id="changeMissile">-</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-title">‚úàÔ∏è Aerei</div>
        <div class="stat-value" id="statAerei">-</div>
        <div class="stat-change" id="changeAerei">-</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-title">üöú Tank</div>
        <div class="stat-value" id="statTank">-</div>
        <div class="stat-change" id="changeTank">-</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-title">üí™ Totale</div>
        <div class="stat-value" id="statTotal">-</div>
        <div class="stat-change" id="changeTotal">-</div>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-title">üìà Trend Crescita (Ultimi 10 Aggiornamenti)</div>
      <div style="position: relative; height: 200px; margin-bottom: 15px;">
        <canvas id="trendChart"></canvas>
      </div>
    </div>

    <div id="rankingSection" class="ranking-card">
      <div class="chart-title">üèÜ Posizione in Alleanza</div>
      <div class="ranking-position" id="rankPosition">-</div>
      <div class="ranking-info" id="rankInfo"></div>
    </div>

    <div class="chart-section">
      <div class="chart-title">üìÖ Storico Aggiornamenti</div>
      <div style="max-height: 300px; overflow-x: auto; overflow-y: auto; -webkit-overflow-scrolling: touch; border: 1px solid #4a6b47; border-radius: 5px;">
        <div id="historyContainer"></div>
      </div>
    </div>

    <button class="btn logout-btn" id="logoutBtn">üö™ Esci</button>
  </div>
</div>
```

  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZAEfVYVoW5tV_FiJBuXAGKCfBLq_39V9JHn5XZe3Zw5cfgQVnRhiTtfUw6zCR44OD/exec';
    
    let chartInstance = null;
    let currentLang = 'it'; // Default: italiano

    // TRADUZIONI
    const translations = {
      it: {
        title: "NGC - Statistiche Personali",
        firstTime: "üÜï Prima volta? Genera PIN",
        alreadyHave: "‚úÖ Ho gi√† un PIN",
        registerTitle: "üìù Registrazione Nuovo Giocatore",
        playerName: "Nome Giocatore",
        secretCode: "Codice Segreto Alleanza",
        generatePIN: "üîê Genera PIN",
        back: "‚Üê Indietro",
        pinGenerated: "‚úÖ PIN Generato con Successo!",
        yourName: "Il tuo nome",
        yourPIN: "Il tuo PIN",
        saveInfo: "üíæ Salva queste informazioni in un posto sicuro!",
        gotoLogin: "üöÄ Vai al Login",
        loginTitle: "üîê Login con PIN",
        enterPIN: "Inserisci PIN",
        login: "üöÄ Accedi",
        welcome: "üëã Benvenuto,",
        missiles: "üöÄ Missili",
        aircraft: "‚úàÔ∏è Aerei",
        tanks: "üöú Tank",
        total: "üí™ Totale",
        trendGrowth: "üìà Trend Crescita (Ultimi 10 Aggiornamenti)",
        alliancePosition: "üèÜ Posizione in Alleanza",
        position: "Posizione:",
        outOf: "su",
        players: "giocatori",
        yourTotal: "üí™ Tuo totale:",
        allianceLeader: "ü•á Leader alleanza:",
        distanceFrom1: "üìä Distacco da #1:",
        allianceAvg: "üìà Media alleanza:",
        history: "üìÖ Storico Aggiornamenti",
        date: "Data",
        logout: "üö™ Esci",
        errorPlayerName: "Inserisci il tuo nome giocatore",
        errorSecretCode: "Inserisci il codice segreto alleanza",
        errorPIN: "Inserisci il tuo PIN",
        errorInvalidCredentials: "Credenziali non valide",
        generatingPIN: "‚è≥ Generazione PIN...",
        loggingIn: "‚è≥ Accesso in corso...",
        noChange: "‚û°Ô∏è Nessuna variazione"
      },
      en: {
        title: "NGC - Personal Stats",
        firstTime: "üÜï First time? Generate PIN",
        alreadyHave: "‚úÖ I already have a PIN",
        registerTitle: "üìù New Player Registration",
        playerName: "Player Name",
        secretCode: "Alliance Secret Code",
        generatePIN: "üîê Generate PIN",
        back: "‚Üê Back",
        pinGenerated: "‚úÖ PIN Generated Successfully!",
        yourName: "Your name",
        yourPIN: "Your PIN",
        saveInfo: "üíæ Save this information in a safe place!",
        gotoLogin: "üöÄ Go to Login",
        loginTitle: "üîê Login with PIN",
        enterPIN: "Enter PIN",
        login: "üöÄ Login",
        welcome: "üëã Welcome,",
        missiles: "üöÄ Missiles",
        aircraft: "‚úàÔ∏è Aircraft",
        tanks: "üöú Tanks",
        total: "üí™ Total",
        trendGrowth: "üìà Growth Trend (Last 10 Updates)",
        alliancePosition: "üèÜ Alliance Position",
        position: "Position:",
        outOf: "out of",
        players: "players",
        yourTotal: "üí™ Your total:",
        allianceLeader: "ü•á Alliance leader:",
        distanceFrom1: "üìä Distance from #1:",
        allianceAvg: "üìà Alliance average:",
        history: "üìÖ Update History",
        date: "Date",
        logout: "üö™ Logout",
        errorPlayerName: "Enter your player name",
        errorSecretCode: "Enter the alliance secret code",
        errorPIN: "Enter your PIN",
        errorInvalidCredentials: "Invalid credentials",
        generatingPIN: "‚è≥ Generating PIN...",
        loggingIn: "‚è≥ Logging in...",
        noChange: "‚û°Ô∏è No change"
      },
      fr: {
        title: "NGC - Statistiques Personnelles",
        firstTime: "üÜï Premi√®re fois? G√©n√©rer un PIN",
        alreadyHave: "‚úÖ J'ai d√©j√† un PIN",
        registerTitle: "üìù Inscription Nouveau Joueur",
        playerName: "Nom du Joueur",
        secretCode: "Code Secret de l'Alliance",
        generatePIN: "üîê G√©n√©rer un PIN",
        back: "‚Üê Retour",
        pinGenerated: "‚úÖ PIN G√©n√©r√© avec Succ√®s!",
        yourName: "Votre nom",
        yourPIN: "Votre PIN",
        saveInfo: "üíæ Sauvegardez ces informations dans un endroit s√ªr!",
        gotoLogin: "üöÄ Aller √† la Connexion",
        loginTitle: "üîê Connexion avec PIN",
        enterPIN: "Entrez le PIN",
        login: "üöÄ Se connecter",
        welcome: "üëã Bienvenue,",
        missiles: "üöÄ Missiles",
        aircraft: "‚úàÔ∏è Avions",
        tanks: "üöú Chars",
        total: "üí™ Total",
        trendGrowth: "üìà Tendance de Croissance (10 Derni√®res Mises √† Jour)",
        alliancePosition: "üèÜ Position dans l'Alliance",
        position: "Position:",
        outOf: "sur",
        players: "joueurs",
        yourTotal: "üí™ Votre total:",
        allianceLeader: "ü•á Chef de l'alliance:",
        distanceFrom1: "üìä Distance du #1:",
        allianceAvg: "üìà Moyenne de l'alliance:",
        history: "üìÖ Historique des Mises √† Jour",
        date: "Date",
        logout: "üö™ D√©connexion",
        errorPlayerName: "Entrez votre nom de joueur",
        errorSecretCode: "Entrez le code secret de l'alliance",
        errorPIN: "Entrez votre PIN",
        errorInvalidCredentials: "Identifiants invalides",
        generatingPIN: "‚è≥ G√©n√©ration du PIN...",
        loggingIn: "‚è≥ Connexion en cours...",
        noChange: "‚û°Ô∏è Aucun changement"
      }
    };

    function t(key) {
      return translations[currentLang][key] || key;
    }

    function updateLanguage() {
      // Title
      document.title = t('title');
      
      // Choice Section
      document.getElementById('firstTimeBtn').textContent = t('firstTime');
      const havePINBtn = document.getElementById('havePINBtn') || document.getElementById('alreadyHavePINBtn');
      if (havePINBtn) havePINBtn.textContent = t('alreadyHave');
      
      // Register Section
      const regTitle = document.querySelector('#registerSection .section-title');
      if (regTitle) regTitle.textContent = `üìù ${t('registerTitle').replace('üìù ', '')}`;
      
      const regPlayerName = document.querySelector('#regPlayerName');
      if (regPlayerName) regPlayerName.placeholder = t('playerName');
      
      const regSecretCode = document.querySelector('#regSecretCode');
      if (regSecretCode) regSecretCode.placeholder = t('secretCode');
      
      const generateBtn = document.getElementById('generatePINBtn');
      if (generateBtn && !generateBtn.disabled) generateBtn.textContent = t('generatePIN');
      
      const backBtn1 = document.getElementById('backToChoiceBtn');
      if (backBtn1) backBtn1.textContent = t('back');
      
      // PIN Display Section  
      const pinTitle = document.querySelector('#pinDisplaySection .section-title');
      if (pinTitle) pinTitle.textContent = `üéâ ${t('pinGenerated').replace('‚úÖ ', '').replace('üéâ ', '')}`;
      
      const gotoPINBtn = document.getElementById('gotoPINLoginBtn');
      if (gotoPINBtn) gotoPINBtn.textContent = t('gotoLogin');
      
      // Login Section
      const loginTitle = document.querySelector('#loginSection .section-title');
      if (loginTitle) loginTitle.textContent = `üîê ${t('loginTitle').replace('üîê ', '')}`;
      
      const loginPlayerName = document.querySelector('#loginPlayerName');
      if (loginPlayerName) loginPlayerName.placeholder = t('playerName');
      
      const loginPIN = document.querySelector('#loginPIN');
      if (loginPIN) loginPIN.placeholder = t('enterPIN');
      
      const loginBtn = document.getElementById('loginBtn');
      if (loginBtn && !loginBtn.disabled) loginBtn.textContent = t('login');
      
      const backBtn2 = document.getElementById('backToChoice2Btn');
      if (backBtn2) backBtn2.textContent = t('back');
      
      // Dashboard stat titles
      const statTitles = document.querySelectorAll('.stat-title');
      if (statTitles.length >= 4) {
        statTitles[0].textContent = t('missiles');
        statTitles[1].textContent = t('aircraft');
        statTitles[2].textContent = t('tanks');
        statTitles[3].textContent = t('total');
      }
      
      // Dashboard chart titles
      const chartTitles = document.querySelectorAll('.chart-title');
      if (chartTitles.length >= 2) {
        chartTitles[0].textContent = `üìà ${t('trendGrowth').replace('üìà ', '')}`;
        chartTitles[1].textContent = `üìÖ ${t('history').replace('üìÖ ', '')}`;
      }
      
      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) logoutBtn.textContent = t('logout');
      
      // Welcome section - update if visible
      const welcomeSection = document.querySelector('.welcome h2');
      if (welcomeSection) {
        const playerName = document.getElementById('welcomeName').textContent;
        if (playerName) {
          welcomeSection.innerHTML = `üëã ${t('welcome')} <span id="welcomeName">${playerName}</span>!`;
        }
      }
    }

    // NAVIGATION
    document.getElementById('firstTimeBtn').addEventListener('click', () => {
      showSection('registerSection');
    });

    document.getElementById('havePINBtn').addEventListener('click', () => {
      showSection('loginSection');
    });

    document.getElementById('backToChoiceBtn').addEventListener('click', () => {
      showSection('choiceSection');
      clearRegisterForm();
    });

    document.getElementById('backToChoice2Btn').addEventListener('click', () => {
      showSection('choiceSection');
      clearLoginForm();
    });

    document.getElementById('gotoPINLoginBtn').addEventListener('click', () => {
      const playerName = document.getElementById('generatedPlayerName').textContent;
      const pin = document.getElementById('generatedPIN').textContent;
      
      document.getElementById('loginPlayerName').value = playerName;
      document.getElementById('loginPIN').value = pin;
      
      showSection('loginSection');
    });

    function showSection(sectionId) {
      ['choiceSection', 'registerSection', 'pinDisplaySection', 'loginSection', 'dashboardSection'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
      document.getElementById(sectionId).style.display = 'block';
    }

    function clearRegisterForm() {
      document.getElementById('regPlayerName').value = '';
      document.getElementById('regSecretCode').value = '';
      document.getElementById('regErrorAlert').style.display = 'none';
    }

    function clearLoginForm() {
      document.getElementById('loginPlayerName').value = '';
      document.getElementById('loginPIN').value = '';
      document.getElementById('loginErrorAlert').style.display = 'none';
    }

    // GENERA PIN
    document.getElementById('generatePINBtn').addEventListener('click', async () => {
      const playerName = document.getElementById('regPlayerName').value.trim();
      const secretCode = document.getElementById('regSecretCode').value.trim();
      const errorAlert = document.getElementById('regErrorAlert');
      const btn = document.getElementById('generatePINBtn');

      errorAlert.style.display = 'none';

      if (!playerName) {
        showError(errorAlert, t('errorPlayerName'));
        return;
      }

      if (!secretCode) {
        showError(errorAlert, t('errorSecretCode'));
        return;
      }

      btn.disabled = true;
      btn.textContent = t('generatingPIN');

      try {
        const url = `${SCRIPT_URL}?action=registerPlayer&playerName=${encodeURIComponent(playerName)}&secretCode=${encodeURIComponent(secretCode)}`;
        const response = await fetch(url, {
          method: 'GET',
          redirect: 'follow'
        });
        const data = await response.json();

        if (data.status === 'success') {
          document.getElementById('generatedPIN').textContent = data.pin;
          document.getElementById('generatedPlayerName').textContent = data.playerName;
          showSection('pinDisplaySection');
        } else {
          showError(errorAlert, data.message || 'Errore durante la generazione del PIN');
        }
      } catch (error) {
        showError(errorAlert, 'Errore di connessione al server');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = t('generatePIN');
      }
    });

    // LOGIN CON PIN
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const playerName = document.getElementById('loginPlayerName').value.trim();
      const pin = document.getElementById('loginPIN').value.trim();
      const errorAlert = document.getElementById('loginErrorAlert');
      const btn = document.getElementById('loginBtn');

      errorAlert.style.display = 'none';

      if (!playerName) {
        showError(errorAlert, t('errorPlayerName'));
        return;
      }

      if (!pin) {
        showError(errorAlert, t('errorPIN'));
        return;
      }

      btn.disabled = true;
      btn.textContent = t('loggingIn');

      try {
        const url = `${SCRIPT_URL}?action=getPlayerStats&playerName=${encodeURIComponent(playerName)}&pin=${encodeURIComponent(pin)}`;
        const response = await fetch(url, {
          method: 'GET',
          redirect: 'follow'
        });
        const data = await response.json();

        if (data.status === 'success') {
          showDashboard(data);
        } else {
          showError(errorAlert, data.message || t('errorInvalidCredentials'));
        }
      } catch (error) {
        showError(errorAlert, 'Errore di connessione al server');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = t('login');
      }
    });

    function showError(element, message) {
      element.textContent = '‚ö†Ô∏è ' + message;
      element.style.display = 'block';
    }

    function showDashboard(data) {
      showSection('dashboardSection');
      
      // Update welcome message with translation
      const welcomeH2 = document.querySelector('.welcome h2');
      if (welcomeH2) {
        welcomeH2.innerHTML = `üëã ${t('welcome')} <span id="welcomeName">${data.playerName}</span>!`;
      } else {
        document.getElementById('welcomeName').textContent = data.playerName;
      }

      updateStatCard('Missile', data.trend.missile);
      updateStatCard('Aerei', data.trend.aerei);
      updateStatCard('Tank', data.trend.tank);
      updateStatCard('Total', data.trend.total);

      createChart(data.chartData);

      if (data.ranking) {
        document.getElementById('rankPosition').textContent = `#${data.ranking.position}`;
        
        let rankHtml = `
          <p>üìä ${t('position')} <strong>#${data.ranking.position}</strong> ${t('outOf')} ${data.ranking.total} ${t('players')}</p>
          <p>${t('yourTotal')} <strong>${formatNumber(data.ranking.playerTotal)}</strong></p>
          <p>${t('allianceLeader')} <strong>${formatNumber(data.ranking.topTotal)}</strong></p>
          <p>${t('distanceFrom1')} <strong>${formatNumber(data.ranking.gapFromTop)}</strong> (-${data.ranking.percentFromTop}%)</p>
        `;
        
        if (data.ranking.allianceAverage) {
          const vsAvg = data.ranking.vsAverage >= 0 ? '+' : '';
          rankHtml += `<p>${t('allianceAvg')} <strong>${formatNumber(data.ranking.allianceAverage)}</strong> (Tu: ${vsAvg}${data.ranking.vsAveragePercent}%)</p>`;
        }
        
        document.getElementById('rankInfo').innerHTML = rankHtml;
      } else {
        document.getElementById('rankingSection').style.display = 'none';
      }

      createHistoryTable(data.history);
    }

    function updateStatCard(type, trend) {
      document.getElementById(`stat${type}`).textContent = formatNumber(trend.current);
      
      const changeEl = document.getElementById(`change${type}`);
      const change = trend.change;
      const percent = trend.percentChange;
      
      let arrow = '';
      let className = 'neutral';
      
      if (change > 0) {
        arrow = '‚¨ÜÔ∏è';
        className = 'positive';
      } else if (change < 0) {
        arrow = '‚¨áÔ∏è';
        className = 'negative';
      } else {
        arrow = '‚û°Ô∏è';
      }
      
      changeEl.className = 'stat-change ' + className;
      changeEl.textContent = `${arrow} ${change >= 0 ? '+' : ''}${formatNumber(change)} (${percent >= 0 ? '+' : ''}${percent}%)`;
    }

    function createChart(chartData) {
      const ctx = document.getElementById('trendChart').getContext('2d');
      
      if (chartInstance) {
        chartInstance.destroy();
      }

      // Calcola variazioni percentuali per ogni punto
      const calculateChange = (data) => {
        return data.map((value, index) => {
          if (index === 0) return null;
          const prev = data[index - 1];
          if (prev === 0) return value > 0 ? 100 : 0;
          return ((value - prev) / prev * 100).toFixed(1);
        });
      };

      const missileData = chartData.map(d => d.missile);
      const aereiData = chartData.map(d => d.aerei);
      const tankData = chartData.map(d => d.tank);
      const totalData = chartData.map(d => d.total);
      
      // FORMATTA LE DATE per le etichette X
      const labels = chartData.map(d => formatDate(d.date));

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'üöÄ Missili',
              data: missileData,
              borderColor: '#ff6b6b',
              backgroundColor: 'rgba(255, 107, 107, 0.1)',
              tension: 0.3
            },
            {
              label: '‚úàÔ∏è Aerei',
              data: aereiData,
              borderColor: '#4ecdc4',
              backgroundColor: 'rgba(78, 205, 196, 0.1)',
              tension: 0.3
            },
            {
              label: 'üöú Tank',
              data: tankData,
              borderColor: '#ffe66d',
              backgroundColor: 'rgba(255, 230, 109, 0.1)',
              tension: 0.3
            },
            {
              label: 'üí™ Totale',
              data: totalData,
              borderColor: '#90EE90',
              backgroundColor: 'rgba(144, 238, 144, 0.1)',
              borderWidth: 3,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          layout: {
            padding: {
              left: 5,
              right: 5,
              top: 5,
              bottom: 15
            }
          },
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#c4e3bf',
                font: { size: 10, family: "'Courier New', monospace" },
                padding: 5,
                boxWidth: 12,
                boxHeight: 12
              }
            },
            tooltip: {
              enabled: true,
              position: 'average',
              yAlign: 'bottom',
              xAlign: 'center',
              caretPadding: 5,
              backgroundColor: 'rgba(30, 40, 30, 0.98)',
              titleColor: '#a8d5a3',
              bodyColor: '#c4e3bf',
              borderColor: '#4a6b47',
              borderWidth: 2,
              padding: 8,
              displayColors: true,
              titleFont: { size: 11, weight: 'bold' },
              bodyFont: { size: 10 },
              callbacks: {
                title: function(context) {
                  const label = context[0].label;
                  // Se la data √® valida, mostrala, altrimenti mostra "Aggiornamento N"
                  if (label && label !== '-' && !label.includes('NaN')) {
                    return 'Data: ' + label;
                  } else {
                    return 'Aggiornamento #' + (context[0].dataIndex + 1);
                  }
                },
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.parsed.y;
                  return label + ': ' + formatNumber(value);
                },
                afterLabel: function(context) {
                  const index = context.dataIndex;
                  if (index === 0) return '';
                  
                  const dataset = context.dataset.data;
                  const current = dataset[index];
                  const previous = dataset[index - 1];
                  
                  if (previous === 0) {
                    return current > 0 ? 'üìà +100%' : '';
                  }
                  
                  const change = current - previous;
                  const percentChange = ((change / previous) * 100).toFixed(1);
                  
                  if (change > 0) {
                    return `üìà +${formatNumber(change)} (+${percentChange}%)`;
                  } else if (change < 0) {
                    return `üìâ ${formatNumber(change)} (${percentChange}%)`;
                  } else {
                    return '‚û°Ô∏è Nessuna variazione';
                  }
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                color: '#a8d5a3',
                font: { size: 10 },
                callback: function(value) {
                  return formatNumber(value);
                }
              },
              grid: { 
                color: 'rgba(74, 107, 71, 0.3)',
                drawBorder: false
              }
            },
            x: {
              ticks: { 
                color: '#a8d5a3',
                font: { size: 10 },
                maxRotation: 0,
                minRotation: 0,
                autoSkip: false,
                padding: 5
              },
              grid: { 
                color: 'rgba(74, 107, 71, 0.3)',
                drawBorder: false
              }
            }
          }
        }
      });
    }

    function createHistoryTable(history) {
      const container = document.getElementById('historyContainer');
      
      let html = '<table class="history-table"><thead><tr>';
      html += `<th>${t('date')}</th><th>${t('missiles')}</th><th>${t('aircraft')}</th><th>${t('tanks')}</th><th>${t('total')}</th>`;
      html += '</tr></thead><tbody>';
      
      const displayHistory = history.slice(0, 20);
      
      displayHistory.forEach(record => {
        const total = record.missile + record.aerei + record.tank;
        html += '<tr>';
        html += `<td>${formatDate(record.date)}</td>`;
        html += `<td>${formatNumber(record.missile)}</td>`;
        html += `<td>${formatNumber(record.aerei)}</td>`;
        html += `<td>${formatNumber(record.tank)}</td>`;
        html += `<td><strong>${formatNumber(total)}</strong></td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      
      if (history.length > 20) {
        html += `<p style="color: #a8d5a3; text-align: center; margin-top: 15px;">Mostrati ultimi 20 di ${history.length} aggiornamenti totali</p>`;
      }
      
      container.innerHTML = html;
    }

    function formatNumber(num) {
      if (!num && num !== 0) return '0,00';
      
      // Converte in stringa e rimuove decimali se presenti
      let str = Math.floor(num).toString();
      
      // Se meno di 2 cifre, aggiungi zeri davanti
      while (str.length < 2) {
        str = '0' + str;
      }
      
      // Inserisci virgola dopo le prime 2 cifre dalla fine
      if (str.length === 2) {
        return '0,' + str;
      } else if (str.length === 3) {
        return str[0] + ',' + str.slice(1);
      } else if (str.length === 4) {
        return str.slice(0, 2) + ',' + str.slice(2);
      } else if (str.length === 5) {
        return str.slice(0, 3) + ',' + str.slice(3);
      } else {
        // Per numeri molto grandi (6+ cifre)
        return str.slice(0, -2) + ',' + str.slice(-2);
      }
    }

    function formatTimestamp(ts) {
      if (!ts) return '-';
      
      try {
        const d = new Date(ts);
        
        // Verifica se la data √® valida
        if (isNaN(d.getTime())) return '-';
        
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        return `${day}/${month}`;
      } catch (e) {
        return '-';
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      
      try {
        let cleanDate = String(dateStr).trim();
        
        // Caso speciale: Formato strano tipo "22T23:00:00.000Z/12"
        if (cleanDate.includes('T') && cleanDate.includes('/')) {
          const parts = cleanDate.split('/');
          if (parts.length === 2) {
            const dayPart = parts[0].split('T')[0]; // Prende solo "22"
            const monthPart = parts[1]; // Prende "12"
            return `${dayPart.padStart(2, '0')}/${monthPart.padStart(2, '0')}`;
          }
        }
        
        // Caso 1: Formato ISO completo (2024-12-22T23:00:00.000Z)
        if (cleanDate.includes('T') && !cleanDate.includes('/')) {
          const d = new Date(cleanDate);
          if (!isNaN(d.getTime())) {
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            return `${day}/${month}`;
          }
        }
        
        // Caso 2: Formato YYYY-MM-DD
        if (cleanDate.match(/^\d{4}-\d{2}-\d{2}/)) {
          const parts = cleanDate.split('-');
          return `${parts[2]}/${parts[1]}`;
        }
        
        // Caso 3: Gi√† in formato corretto (22/12)
        if (cleanDate.match(/^\d{1,2}\/\d{1,2}$/)) {
          const parts = cleanDate.split('/');
          return `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}`;
        }
        
        // Caso 4: Prova a parsare come Date
        const d = new Date(cleanDate);
        if (!isNaN(d.getTime())) {
          const day = String(d.getDate()).padStart(2, '0');
          const month = String(d.getMonth() + 1).padStart(2, '0');
          return `${day}/${month}`;
        }
        
        return '-';
      } catch (e) {
        return '-';
      }
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
      showSection('choiceSection');
      clearLoginForm();
      clearRegisterForm();
      
      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }
    });

    // LANGUAGE SELECTOR
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentLang = btn.dataset.lang;
        
        // Update active button
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update all text
        updateLanguage();
        
        // Save preference
        localStorage.setItem('ngc-lang', currentLang);
      });
    });

    // Load saved language preference
    const savedLang = localStorage.getItem('ngc-lang');
    if (savedLang && ['it', 'en', 'fr'].includes(savedLang)) {
      currentLang = savedLang;
      document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-lang="${savedLang}"]`).classList.add('active');
    }
    
    // Initialize language
    updateLanguage();
  </script>

</body>
</html>